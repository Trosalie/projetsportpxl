<section class="profile">
  <app-title [title]="name" [icon]="''"></app-title>
  <app-popup #popup></app-popup>
  <app-confirm-modal
    [isVisible]="showDeleteModal"
    [invoiceData]="deleteModalData"
    [titleText]="'Confirmer la suppression'"
    [checkboxLabel]="'Je confirme la suppression de ce photographe'"
    [confirmLabel]="'Supprimer'"
    [cancelLabel]="'Annuler'"
    [showAmount]="false"
    (confirm)="onConfirmDelete()"
    (discard)="onCancelDelete()">
  </app-confirm-modal>

  <!-- Modal Changement de mot de passe -->
  <div class="password-modal-overlay" *ngIf="showPasswordModal" (click)="closePasswordModal()">
    <div class="password-modal" (click)="$event.stopPropagation()">
      <div class="password-modal_header">
        <h3>Modifier le mot de passe</h3>
        <button class="close-btn" type="button" (click)="closePasswordModal()" aria-label="Fermer la modale">×</button>
      </div>
      
      <div class="password-modal_content">
        <p *ngIf="passwordModalError" class="error-message">{{ passwordModalError }}</p>
        <p *ngIf="passwordModalSuccess" class="success-message">{{ passwordModalSuccess }}</p>

        <form *ngIf="!passwordModalSuccess" (ngSubmit)="changePassword()">
          <div class="form-group">
            <label for="current-password">Mot de passe actuel</label>
            <input 
              type="password"
              id="current-password"
              [(ngModel)]="passwordModalData.currentPassword"
              name="currentPassword"
              required
              [disabled]="passwordModalLoading"
            />
          </div>

          <div class="form-group">
            <label for="new-password">Nouveau mot de passe</label>
            <input 
              type="password"
              id="new-password"
              [(ngModel)]="passwordModalData.newPassword"
              name="newPassword"
              required
              [disabled]="passwordModalLoading"
            />
            <small>Minimum 8 caractères</small>
          </div>

          <div class="form-group">
            <label for="confirm-password">Confirmer le mot de passe</label>
            <input 
              type="password"
              id="confirm-password"
              [(ngModel)]="passwordModalData.confirmPassword"
              name="confirmPassword"
              required
              [disabled]="passwordModalLoading"
            />
          </div>

          <div class="password-modal_actions">
            <button type="button" class="btn-cancel" (click)="closePasswordModal()" [disabled]="passwordModalLoading">
              Annuler
            </button>
            <button type="submit" class="btn-confirm" [disabled]="passwordModalLoading">
              <span *ngIf="!passwordModalLoading">Modifier</span>
              <span *ngIf="passwordModalLoading" class="spinner-small"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="loading-overlay" *ngIf="isLoading">
    <div class="spinner"></div>
    <p>Chargement du profil...</p>
  </div>

  <div class="profile_layout" *ngIf="!isLoading">
    <section class="card info-card">
      <div class="card_header">
        <h2 class="card_title">Informations générales</h2>
        <div class="card_actions">
          <button class="btn-modify" type="button" (click)="openPasswordModal()">Modifier le mot de passe</button>
        </div>
      </div>
      <div class="info-card_content">
        <div class="identity">
          <div class="identity_name">{{ family_name || name }} {{ given_name }}</div>
          <div class="identity_email" *ngIf="email">{{ email }}</div>
        </div>
        <div class="info-row">
          <span class="info-row_label">Nom</span>
          <span class="info-row_value">{{ family_name || name }}</span>
        </div>
        <div class="info-row">
          <span class="info-row_label">Prénom</span>
          <span class="info-row_value">{{ given_name }}</span>
        </div>
        <div class="info-row">
          <span class="info-row_label">email</span>
          <span class="info-row_value">{{ email }}</span>
        </div>

        <div class="address-card">
          <div class="address-card_item">
            <span class="info-row_label">Adresse</span>
            <span class="info-row_value">{{ street_address }}</span>
          </div>
          <div class="address-card_item">
            <span class="info-row_label">Ville</span>
            <span class="info-row_value">{{ locality }}</span>
          </div>
          <div class="address-card_item">
            <span class="info-row_label">Code postal</span>
            <span class="info-row_value">{{ postal_code }}</span>
          </div>
          <div class="address-card_item">
            <span class="info-row_label">Pays</span>
            <span class="info-row_value">{{ country }}</span>
          </div>
        </div>
      </div>
    </section>

    <section class="card metrics-card">
      <div class="metrics">
        <div class="metric metric--turnover">
          <div class="metric_label">Chiffre d'affaire</div>
          <div class="metric_value">{{ turnover | number:'1.0-9':'fr-FR' }} €</div>
        </div>
        <div class="metric metric--credits">
          <div class="metric_label">Crédits restants</div>
          <div class="metric_value">{{ remainingCredits }}</div>
        </div>
      </div>

      <div class="chart-card">
        <div class="filter-section-sidebar">
          <div class="filter-label">Filtres</div>

          <div class="filter-buttons-vertical">
            <div class="filter-dropdown-container">
              <button class="filter-button" [class.active]="hasActiveDataTypeFilters()"
                (click)="toggleDropdown('dataType', $event)">
                <img src="assets/category_icon.png" alt="Type" class="filter-icon">
                <span>Type de données</span>
                <button *ngIf="hasActiveDataTypeFilters()" class="clear-category-btn"
                  (click)="clearCategoryFilters('dataType', $event)">
                  <img src="assets/close_icon.png" alt="Clear">
                </button>
              </button>
              <div class="dropdown-menu" *ngIf="openDropdown === 'dataType'" (click)="$event.stopPropagation()">
                <label class="checkbox-item" *ngFor="let type of dataTypeFilters">
                  <input type="checkbox" [checked]="isFilterActive(type)" (change)="toggleFilter(type)">
                  <span>{{ type }}</span>
                </label>
              </div>
            </div>

            <div class="filter-dropdown-container">
              <button class="filter-button" [class.active]="hasActivePeriodFilters()"
                (click)="toggleDropdown('period', $event)">
                <img src="assets/calendar_icon.png" alt="Période" class="filter-icon">
                <span>Période</span>
                <button *ngIf="hasActivePeriodFilters()" class="clear-category-btn"
                  (click)="clearCategoryFilters('period', $event)">
                  <img src="assets/close_icon.png" alt="Clear">
                </button>
              </button>
              <div class="dropdown-menu period-dropdown" *ngIf="openDropdown === 'period'"
                (click)="$event.stopPropagation()">
                <div class="date-filter-item" *ngFor="let period of periodFilters">
                  <label class="checkbox-item">
                    <input type="checkbox" [checked]="isFilterActive(period)"
                      (change)="toggleFilter(period); isFilterActive(period) && addDateFilter(period)">
                    <span>{{ period }}</span>
                  </label>
                  <input *ngIf="isFilterActive(period)" type="date" class="date-input" [attr.data-filter]="period"
                    [value]="getDateValue(period)" (change)="updateDateFilter(period, $event)"
                    (click)="$event.stopPropagation()">
                </div>
              </div>
            </div>

            <button class="apply-button" (click)="applyFilters()" [disabled]="!canApplyFilters()">
              Appliquer
            </button>
          </div>
        </div>

        <div class="chart-container" style="height: 300px; width: 100%; position: relative;">
          <canvas #lineChartCanvas></canvas>
        </div>
      </div>
    </section>
  </div>
</section>